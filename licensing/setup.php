<?php defined('ABSPATH')||exit('WP absolute path is not defined.');class EDD_SL_Quick_Plugin_Starter{private $_prefix,$_index,$_root,$_root_url,$_website_url,$_product_data,$_admin_data,$_validation_data;public function __construct($product_args=[],$admin_args=[],$validation_args=[],$index=''){$this->_test_defaults($product_args,$admin_args,$validation_args,$index);$this->_prefix=$admin_args['Prefix'];$this->_index=$index;$this->_root=plugin_dir_path($this->_index);$this->_root_url=plugin_dir_url($this->_index);$this->_website_url=get_home_url();$this->_product_data['url']=$product_args['Website'];$this->_product_data['name']=$product_args['Name'];$this->_product_data['product_id']=$product_args['ID'];$this->_product_data['version']=$product_args['Version'];$this->_admin_data['menu_title']=$admin_args['Menu Title'];$this->_admin_data['capability']=$admin_args['User Capability'];$this->_admin_data['is_top_level']=$admin_args['Top Level Menu'];$this->_admin_data['merge_pages']=$admin_args['License on Home'];$this->_admin_data['use_nav_tabs']=$admin_args['Use Tabs'];$this->_admin_data['include_system_info']=$admin_args['Include System Info'];$this->_admin_data['icon_url']=isset($admin_args['Icon URL'])?$admin_args['Icon URL']:'';if(isset($admin_args['Parent Slug'])&&$admin_args['Parent Slug']!==''){$this->_admin_data['parent_slug']=$admin_args['Parent Slug'];}if(isset($admin_args['Menu Position'])&&$admin_args['Menu Position']!==null){$this->_admin_data['menu_position']=$admin_args['Menu Position'];}$this->_validation_data['use_remote_on_init']=$validation_args['Use Remote on Init'];$this->_validation_data['check_remote_on_shutdown']=$validation_args['Check Remote on Shutdown'];if(!class_exists('EDD_SL_Quick_Plugin_Starter_Admin_Helper')){require_once $this->_root.'admin/class.helper.php';}$this->admin=new EDD_SL_Quick_Plugin_Starter_Admin_Helper($this->_prefix,$this->_admin_data['capability']);add_action('admin_init',[$this,'plugin_updater']);add_action('admin_menu',[$this,'create_default_admin_pages'],999);add_action('admin_init',[$this,'register_default_admin_settings']);add_action('admin_init',[$this,'register_license_setting']);add_action('admin_init',[$this,'activate_license']);add_action('admin_init',[$this,'deactivate_license']);add_action('admin_init',[$this,'clear_license']);add_action('admin_notices',[$this,'license_notices']);add_action('admin_enqueue_scripts',[$this,'enqueue_admin_scripts']);}private function _test_defaults($product_args=[],$admin_args=[],$validation_args=[],$index=''){if(empty($product_args)){exit('Product Arguments cannot be empty.');}if(!isset($product_args['Website'])||$product_args['Website']===''){exit('Website must be set in Product Arguments.');}if(!isset($product_args['Name'])||$product_args['Name']===''){exit('Name must be set in Product Arguments.');}if(!isset($product_args['ID'])||$product_args['ID']===''){exit('ID must be set in Product Arguments.');}if(!isset($product_args['Version'])||$product_args['Version']===''){exit('Version must be set in Product Arguments.');}if(empty($admin_args)){exit('Admin Arguments cannot be empty.');}if(!isset($admin_args['Prefix'])||$admin_args['Prefix']===''){exit('Prefix must be set in Admin Arguments.');}if(!isset($admin_args['Menu Title'])||$admin_args['Menu Title']===''){exit('Menu Title must be set in Admin Arguments.');}if(!isset($admin_args['User Capability'])||$admin_args['User Capability']===''){exit('User Capability must be set in Admin Arguments.');}if(!isset($admin_args['Top Level Menu'])||$admin_args['Top Level Menu']===''){exit('Top Level Menu must be set in Admin Arguments.');}if(!isset($admin_args['License on Home'])||$admin_args['License on Home']===''){exit('License on Home must be set in Admin Arguments.');}if(!isset($admin_args['Icon URL'])){exit('Icon URL can be \'\', but must be set in Admin Arguments.');}if(!isset($admin_args['Use Tabs'])){exit('Use Tabs must be set to true or false in Admin Arguments.');}if(isset($admin_args['Top Level Menu'])&&$admin_args['Top Level Menu']===false&&(!isset($admin_args['Parent Slug'])||$admin_args['Parent Slug']==='')){exit('Parent Slug must be set in Admin Arguments because Top Level Menu is false.');}if(isset($admin_args['Top Level Menu'])&&$admin_args['Top Level Menu']===true&&(!isset($admin_args['Menu Position'])||$admin_args['Menu Position']===null)){exit('Menu Position must be set in Admin Arguments because Top Level Menu is true.');}if(empty($validation_args)){exit('Admin Arguments cannot be empty.');}if(!isset($validation_args['Use Remote on Init'])){exit('Use Remote on Init must be set to true or false in Validation Arguments.');}if(!isset($validation_args['Check Remote on Shutdown'])){exit('Check Remote on Shutdown must be set to true or false in Validation Arguments.');}if($index===''){exit('Index has been removed. Put it back!');}}public function get_plugin_prefix(){return $this->_prefix;}public function get_plugin_index(){return $this->_index;}public function get_plugin_root(){return $this->_root;}public function get_plugin_root_url(){return $this->_root_url;}public function get_product_info($data_request=''){if(!$data_request||$data_request===''){return false;}return $this->_product_data[$data_request];}public function get_admin_info($data_request=''){if(!$data_request||$data_request===''){return false;}return $this->_admin_data[$data_request];}public function create_default_admin_pages(){if($this->_admin_data['is_top_level']){add_menu_page($this->_product_data['name'],$this->_admin_data['menu_title'],$this->_admin_data['capability'],$this->_prefix.'_home',[$this,'get_home_page'],$this->_admin_data['icon_url'],$this->_admin_data['menu_position']);$this->admin->register_page('Home','home',[$this,'get_home_page']);}else{add_submenu_page($this->_admin_data['parent_slug'],$this->_product_data['name'],$this->_admin_data['menu_title'],$this->_admin_data['capability'],$this->_prefix.'_home',[$this,'get_home_page'],$this->_admin_data['menu_position']);register_setting($this->_prefix.'_home',$this->_prefix.'_home');}if(!$this->_admin_data['merge_pages']){$this->admin->register_page('License','license_key',[$this,'get_license_page']);}}public function register_default_admin_settings(){}public function get_navigation_tabs(){if($this->_admin_data['use_nav_tabs']){ ?> <div class="nav-tab-wrapper"> <a href="?page=<?php echo $this->_prefix; ?>_home" class="nav-tab">Home</a> <?php if(!$this->_admin_data['merge_pages']){ ?> <a href="admin.php?page=<?php echo $this->_prefix; ?>_license_key" class="nav-tab">License</a> <?php if($this->_admin_data['include_system_info']){ ?> <a href="admin.php?page=<?php echo $this->_prefix; ?>_system_info" class="nav-tab">System</a> <?php }}do_action($this->_prefix.'_navigation_tabs'); ?> </div> <?php }}public function get_home_page(){$prefix=$this->_prefix;echo '<div class="wrap">';$this->get_navigation_tabs();include_once $this->_root.'admin/home.php';if($this->_admin_data['merge_pages']){include_once $this->get_plugin_root().'admin/license.php';if($this->_admin_data['include_system_info']){include_once $this->get_plugin_root().'admin/system.php';}}echo '</div>';}public function get_license_page(){$prefix=$this->_prefix;echo '<div class="wrap">';$this->get_navigation_tabs();include_once $this->get_plugin_root().'admin/license.php';echo '</div>';}public function plugin_updater(){if(!class_exists('EDD_SL_Quick_Plugin_Starter_Plugin_Updater')){require_once 'updater.php';}$license_key=trim(get_option($this->_prefix.'_license_key'));$edd_updater=new EDD_SL_Quick_Plugin_Starter_Plugin_Updater($this->_product_data['url'],$this->_index,array('version'=>$this->_product_data['version'],'license'=>$license_key,'item_id'=>$this->_product_data['product_id'],'author'=>'Ukuwi','beta'=>false,));}public function check_license_locally(){$license_key=get_option($this->_prefix.'_license_key');$license_status=get_option($this->_prefix.'_license_status');if($license_key&&$license_status=='valid'){return true;}return false;}public function check_license_remotely(){if($license_key=get_option($this->_prefix.'_license_key')){global $wp_version;$license=trim($license_key);$api_params=['edd_action'=>'check_license','license'=>$license,'item_name'=>urlencode($this->_product_data['name']),'url'=>$this->_website_url];$response=wp_remote_post($this->_product_data['url'],['timeout'=>15,'sslverify'=>false,'body'=>$api_params]);if(is_wp_error($response)){return false;}$license_data=json_decode(wp_remote_retrieve_body($response));$remote_validity=$license_data->license=='valid'?true:false;if(!$remote_validity&&get_option($this->_prefix.'_license_status')){delete_option($this->_prefix.'_license_key');delete_option($this->_prefix.'_license_status');}elseif($remote_validity&&get_option($this->_prefix.'_license_key')){update_option($this->_prefix.'_license_status',$license_data->license);}return $remote_validity;}}public function register_license_setting(){register_setting($this->_prefix.'_license_key',$this->_prefix.'_license_key',[$this,'sanitize_license']);}public function activate_license(){if(isset($_POST[$this->_prefix.'_license_activate'])){$redirect_suffix=$this->_admin_data['merge_pages']?'_home':'_license_key';if(!check_admin_referer($this->_prefix.'_nonce',$this->_prefix.'_nonce')){return;}if(isset($_POST[$this->_prefix.'_license_key'])&&$_POST[$this->_prefix.'_license_key']!==''){update_option($this->_prefix.'_license_key',$_POST[$this->_prefix.'_license_key']);}else{return;}$license=trim(get_option($this->_prefix.'_license_key'));$api_params=array('edd_action'=>'activate_license','license'=>$license,'item_name'=>urlencode($this->_product_data['name']),'url'=>$this->_website_url);$response=wp_remote_post($this->_product_data['url'],array('timeout'=>15,'sslverify'=>false,'body'=>$api_params));if(is_wp_error($response)||200!==wp_remote_retrieve_response_code($response)){if(is_wp_error($response)){$message=$response->get_error_message();}else{$message=__('An error occurred, please try again.');}}else{$license_data=json_decode(wp_remote_retrieve_body($response));if(false===$license_data->success){switch($license_data->error){case 'expired':$message=sprintf(__('Your license key expired on %s.'),date_i18n(get_option('date_format'),strtotime($license_data->expires,current_time('timestamp'))));break;case 'disabled':case 'revoked':$message=__('Your license key has been disabled.');break;case 'missing':$message=__('Invalid license.');break;case 'invalid':case 'site_inactive':$message=__('Your license is not active for this URL.');break;case 'item_name_mismatch':$message=sprintf(__('This appears to be an invalid license key for %s.'),$this->_product_data['name']);break;case 'no_activations_left':$message=__('Your license key has reached its activation limit.');break;default:$message=__('An error occurred, please try again.');break;}}}if(!empty($message)){$base_url=admin_url('admin.php?page='.$this->_prefix.$redirect_suffix);$redirect=add_query_arg(array('sl_activation'=>'false','message'=>urlencode($message)),$base_url);wp_redirect($redirect);exit();}update_option($this->_prefix.'_license_status',$license_data->license);wp_redirect(admin_url('admin.php?page='.$this->_prefix.$redirect_suffix));exit();}}public function deactivate_license(){if(isset($_POST[$this->_prefix.'_license_deactivate'])):$redirect_suffix=$this->_admin_data['merge_pages']?'_home':'_license_key';if(!check_admin_referer($this->_prefix.'_nonce',$this->_prefix.'_nonce'))return;$license=trim(get_option($this->_prefix.'_license_key'));$api_params=array('edd_action'=>'deactivate_license','license'=>$license,'item_name'=>urlencode($this->_product_data['name']),'url'=>$this->_website_url);$response=wp_remote_post($this->_product_data['url'],array('timeout'=>15,'sslverify'=>false,'body'=>$api_params));if(is_wp_error($response)||200!==wp_remote_retrieve_response_code($response)):if(is_wp_error($response)):$message=$response->get_error_message();else:$message=__('An error occurred, please try again.');endif;$base_url=admin_url('admin.php?page='.$this->_prefix.$redirect_suffix);$redirect=add_query_arg(array('sl_activation'=>'false','message'=>urlencode($message)),$base_url);wp_redirect($redirect);exit();endif;$license_data=json_decode(wp_remote_retrieve_body($response));if($license_data->license=='deactivated'){delete_option($this->_prefix.'_license_status');delete_option($this->_prefix.'_license_key');if(get_option($this->_prefix.'_api_data')):delete_option('_transient_'.$this->_prefix.'_api_data');delete_option('_transient_timeout_'.$this->_prefix.'_api_data');endif;}wp_redirect(admin_url('admin.php?page='.$this->_prefix.$redirect_suffix));exit();endif;}public function clear_license(){if(isset($_POST[$this->_prefix.'_license_clear'])):delete_option($this->_prefix.'_license_status');delete_option($this->_prefix.'_license_key');if(get_option('_transient_timeout_'.$this->_prefix.'_api_data')):delete_option('_transient_'.$this->_prefix.'_api_data');delete_option('_transient_timeout_'.$this->_prefix.'_api_data');endif;$redirect_suffix=$this->_admin_data['merge_pages']?'_home':'_license_key';wp_redirect(admin_url('admin.php?page='.$this->_prefix.$redirect_suffix));exit();endif;}public function license_notices(){if(isset($_GET['sl_activation'])&&!empty($_GET['message'])):switch($_GET['sl_activation']){case 'false':$message=urldecode($_GET['message']); ?> <div class="error"> <p><?php echo $message; ?></p> </div> <?php break;case 'true':default:break;}endif;}public function sanitize_license($new){$old=get_option($this->_prefix.'_license_key');if($old&&$old!=$new)delete_option($this->_prefix.'_license_status');return $new;}public function enqueue_admin_scripts($hook){if(strpos($hook,$this->_prefix)):wp_enqueue_script($this->_prefix.'-admin-scripts',$this->_root_url.'admin/scripts.js',[],$this->_product_data['version']);wp_enqueue_style($this->_prefix.'-admin-styles',$this->_root_url.'admin/styles.css',[],$this->_product_data['version']);endif;}public function init(){if($this->_validation_data['check_remote_on_shutdown'])add_action('shutdown',[$this,'check_license_remotely']);return $this->_validation_data['use_remote_on_init']?$this->check_license_remotely():$this->check_license_locally();}}